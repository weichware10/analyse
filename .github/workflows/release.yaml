name: create-release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag'
        required: true
        default: 'v*.*'
      snapshot:
        description: 'The next snapshot'
        required: true
        default: 'v*.*-SNAPSHOT'

jobs:
  # RUN TESTS
  run-tests:
      runs-on: ubuntu-latest
      # limit to owners
      if: contains('["joshuajeschek, weichbot10"]', github.actor)
      steps:
        - uses: actions/checkout@v2
        - name: setup java 17
          uses: actions/setup-java@v2
          with:
            distribution: 'adopt'
            java-version: '17'
            cache: 'maven'
        - run: mvn -B test --file pom.xml
  # CREATE TAG AND UPDATE POM.XML
  create-tag:
    runs-on: ubuntu-latest
    # do not release on failing tests
    needs: run-tests
    # limit to owners
    if: contains('["joshuajeschek, weichbot10"]', github.actor)
    outputs:
      changes_detected: ${{ steps.auto-commit-action.outputs.changes_detected }}
    steps:
      # checkout
      - name: checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.WEICHBOT }}
      # setup java (default is not 17)
      - name: setup java 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'
          cache: 'maven'
      # increase /project/version of pom.xml
      - name: increase version in pom.xml
        run: mvn versions:set -DnewVersion="${{ github.event.inputs.tag }}"
      # signed commits
      - name: import GPG
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v4
        with:
          gpg_private_key: ${{ secrets.WEICHBOT_GPG_PRIVATE }}
          passphrase: ${{ secrets.WEICHBOT_GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
      # commit changed pom file
      - name: auto commit
        id: auto-commit-action
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: pom.xml
          commit_message: '[chore] bump version to ${{ github.event.inputs.tag }}'
          commit_user_name: 'weichbot10'
          commit_user_email: 'weichbot10@users.noreply.github.com'
          tagging_message: ${{ github.event.inputs.tag }}
      # carry over commitid to next job
      - name: set output
        run: |
          SHA=$(git rev-parse HEAD)
          echo "::set-output name=commitid::$SHA"

  # CREATE THE ACTUAL RELEASE
  create-release:
    runs-on: ubuntu-latest
    needs: create-tag
    if: needs.create-tag.outputs.changes_detected == 'true'
    steps:
      # checkout
      - name: checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.WEICHBOT }}
      # get commit from previous job
      - run: git pull
      # setup java (default is not 17)
      - name: setup java 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'
          cache: 'maven'
      # package to jar
      - name: package project
        run: mvn package
      # create release and add packaged jar
      - name: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: target/*.jar
          token: ${{ secrets.WEICHBOT }}
          generate_release_notes: true
          fail_on_unmatched_files: true
      # set version number to snapshot version
      - name: bump pom.xml
        run: mvn versions:set -DnewVersion="${{ github.event.inputs.snapshot }}"
      # signed commits
      - name: import GPG
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v4
        with:
          gpg_private_key: ${{ secrets.WEICHBOT_GPG_PRIVATE }}
          passphrase: ${{ secrets.WEICHBOT_GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
      # commit changed pom file
      - name: auto commit
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          file_pattern: pom.xml
          commit_message: '[chore] set snapshot version (${{ github.event.inputs.snapshot }})'
          commit_user_name: 'weichbot10'
          commit_user_email: 'weichbot10@users.noreply.github.com'
